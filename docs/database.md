# Database

We use Prisma with PostgreSQL and Accelerate.

Basic usage is very simple:
1. All the database operations are in `src/services/db/`. Here we isolate logic of interacting with the database.
2. Definition of models is in `prisma/schema.prisma`. There you'll find migrations as well.
3. Database instance is in `src/services/db/prisma.ts`. Very minimalistic, so don't touch it.
4. If we change the models, we need to run `make prisma-migrate-dev` to update the migrations. It will automatically create a new migration file in `prisma/migrations` and apply it to the database. [More details below]

> [!IMPORTANT]
> We currently have only development database. Production one comes soon.

Example usage (script for testing db ops):

```bash
make run CMD="scripts/db-connection.ts"
```

## Prisma Client

This is the client for interacting with the database. It's generated by Prisma, so we don't have to write it manually. However, there're some important settings:

- The client is generated into `node_modules/.prisma/client`
- We need to copy it to the build stage in `Dockerfile`
- We need to generate the client after reinstalling dependencies

```bash
pnpm prisma generate --no-engine
```

## Encryption

We use `prisma-field-encryption` to encrypt the fields in the database. There're important things to remember:

- Always use `/// @encrypted` annotation to encrypt the field.
- Do not query encrypted fields!
- Store the encryption key in the environment variable

For more details - refer to the [prisma-field-encryption](https://github.com/47ng/prisma-field-encryption) repo.

## Migrations

Migrations are handled by Prisma, so we don't have to write them manually. Just change the models in `prisma/schema.prisma` and run:

```bash
make migrate
```

This will create a new migration file in `prisma/migrations` and apply it to the database.

## Backups

We don't have Pro plan atm, so we need to manually backup the database. This is very simple:

1. Run the tunnel:

```bash
pnpm ppg-tunnel --host 127.0.0.1  --port 5432
```

2. Run the backup:

```bash
PGSSLMODE=disable \
pg_dump \
  -h 127.0.0.1 \
  -p 5432 \
  -Fc \
  -v \
  -d postgres \
  -f ./mydatabase.bak \
&& echo "-complete-"
```

Note, that you need to have `pg_dump` (comes with PostgreSQL) installed.

> TODO: Add simple postgres docker container to run the backup. 